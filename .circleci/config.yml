version: "2.1"

# Parameters. {{{

parameters:

    # Bump this to reset all caches.
    cache_epoch:
      type: integer
      default: 0

# }}}

# Executors. {{{

executors:

  base:
    docker:
      - image: koreader/kobase:0.3.2-20.04

  base-clang:
    docker:
      - image: koreader/kobase-clang:0.3.3-20.04

  xcompile:
    machine: true

# }}}

# Jobs. {{{

jobs:

  # Lint. {{{

  lint:
    executor: base
    environment:
      BASH_ENV: "~/.bashrc"
    steps:
      - checkout
      - run:
          name: lint
          command: source .ci/lint_script.sh

  # }}}

  # Build & Test. {{{

  build: &BUILD_TPL
    executor: base
    environment: &BUILD_ENV_LST
      BASH_ENV: "~/.bashrc"
      CCACHE_MAXSIZE: "256M"
      MAKEFLAGS: "OUTPUT_DIR=build"
    parameters:
      cache_path:
        type: string
        default: "/home/ko/.ccache"
    steps:
      - checkout
      - run:
          name: Generate cache key
          command: make TARGET= cache-key
      - restore_cache:
          name: Restore build cache
          keys:
            - &CACHE_KEY_BUILD_CACHE '<< pipeline.parameters.cache_epoch >>-{{ .Environment.CIRCLE_JOB }}-ccache-{{ arch }}-{{ checksum "cache-key" }}'
            - '<< pipeline.parameters.cache_epoch >>-{{ .Environment.CIRCLE_JOB }}-ccache-{{ arch }}-'
      - run:
          name: Build
          command: source .ci/build_script.sh
      - save_cache:
          name: Save build cache
          key: *CACHE_KEY_BUILD_CACHE
          paths:
            - << parameters.cache_path >>
      - run:
          name: Test
          command: source .ci/test_script.sh

  # }}}

  # Emulator. {{{

  emu: &EMU_TPL
    <<: *BUILD_TPL
    environment: &EMU_ENV_LST
      <<: *BUILD_ENV_LST
      EMULATE_READER: "1"
      CC: "gcc"

  emu_gcc_ninja:
    <<: *EMU_TPL

  emu_gcc_ninja_debug:
    <<: *EMU_TPL
    environment:
      <<: *EMU_ENV_LST
      KODEBUG: "1"
      # TODO: reduce once a more recent version of ccache with
      # zstd support and compression enabled by default is used.
      CCACHE_MAXSIZE: "1G"

  emu_gcc_make:
    <<: *EMU_TPL
    environment:
      <<: *EMU_ENV_LST
      USE_MAKE: "1"

  emu_clang_ninja:
    <<: *EMU_TPL
    executor: base-clang
    environment:
      <<: *EMU_ENV_LST
      CC: "clang"
      CXX: "clang++"

  # }}}

  # Platforms. {{{

  xcompile: &XCOMPILE_TPL
    <<: *BUILD_TPL
    executor: xcompile
    parameters:
      cache_path:
        type: string
        default: "/home/circleci/.ccache"

  android-arm: &ANDROID_TPL
    <<: *XCOMPILE_TPL
    environment:
      <<: *BUILD_ENV_LST
      TARGET: "android"
      DOCKER_IMG: koreader/koandroid:0.8.1-20.04

  android-x86:
    <<: *ANDROID_TPL
    environment:
      <<: *BUILD_ENV_LST
      TARGET: "android"
      ANDROID_ARCH: "x86"
      DOCKER_IMG: koreader/koandroid:0.8.1-20.04

  cervantes:
    <<: *XCOMPILE_TPL
    environment:
      <<: *BUILD_ENV_LST
      TARGET: "cervantes"
      DOCKER_IMG: koreader/kocervantes:0.3.2-20.04

  kindle:
    <<: *XCOMPILE_TPL
    environment:
      <<: *BUILD_ENV_LST
      TARGET: "kindle"
      DOCKER_IMG: koreader/kokindle:0.3.2-20.04

  kobo:
    <<: *XCOMPILE_TPL
    environment:
      <<: *BUILD_ENV_LST
      TARGET: "kobo"
      DOCKER_IMG: koreader/kokobo:0.3.2-20.04

  pocketbook:
    <<: *XCOMPILE_TPL
    environment:
      <<: *BUILD_ENV_LST
      TARGET: "pocketbook"
      DOCKER_IMG: koreader/kopb:0.4.1-20.04

  sony-prstux:
    <<: *XCOMPILE_TPL
    environment:
      <<: *BUILD_ENV_LST
      TARGET: "sony-prstux"
      DOCKER_IMG: koreader/kobase-22.04:0.3.0

  # }}}

# }}}

# Workflows. {{{

workflows:

  version: 2

  lint_build_test:

    jobs:

      - lint

      # Emulators. {{{

      - emu_gcc_ninja:
          filters:
            branches:
              only: master
          requires:
            - lint

      - emu_gcc_ninja_debug:
          requires:
            - lint

      - emu_gcc_make:
          filters:
            branches:
              only: master
          requires:
            - lint

      - emu_clang_ninja:
          requires:
            - lint

      # }}}

      # Platforms. {{{

      - android-arm:
          requires:
            - emu_gcc_ninja_debug

      - android-x86:
          filters:
            branches:
              only: master
          requires:
            - emu_gcc_ninja_debug

      - cervantes:
          requires:
            - emu_gcc_ninja_debug

      - kindle:
          requires:
            - emu_gcc_ninja_debug

      - kobo:
          requires:
            - emu_gcc_ninja_debug

      - pocketbook:
          requires:
            - emu_gcc_ninja_debug

      - sony-prstux:
          requires:
            - emu_gcc_ninja_debug

      # }}}

# }}}

# vim: foldmethod=marker foldlevel=0
